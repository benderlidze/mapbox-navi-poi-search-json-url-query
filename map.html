<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Change a map's style configuration property</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
</head>
<style>
    body {
        margin: 0;
        padding: 0;
    }

    #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
    }

    .mapboxgl-popup {
        width: 300px;
    }

    #marker {
        background-size: cover;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        cursor: pointer;
        border: 1px solid white;
    }

    .popup-img {
        max-width: 100%;
    }

    #menu {
        position: absolute;
        background: #efefef;
        padding: 10px;
        font-family: "Open Sans", sans-serif;
    }

    .mapboxgl-ctrl-top-left {
        top: 100px !important;
    }

    .logo {
        position: absolute;
        top: 0;
        left: 0;
        padding: 10px;
        font-family: "Open Sans", sans-serif;
    }

    #filters {
        position: absolute;
        top: 60px;
        left: 0px;
        padding: 10px;
        font-family: "Open Sans", sans-serif;
        z-index: 100;

        display: flex;
        flex-direction: row;
    }

    .filter-item {
        display: flex;
        padding: 5px 10px;
        justify-content: space-between;
        align-items: center;
        flex-direction: row;
        color: white;
        width: 90px;
        cursor: pointer;
        /* border-bottom: 3px solid transparent; */
    }

    .selected {
        box-shadow: inset 0 -3px 0 0 white;
    }

    .filter-icon {
        width: 20px;
        height: 20px;
    }
</style>

<body>
    <script
        src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css"
        type="text/css">

    <script
        src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.3.1/mapbox-gl-directions.js"></script>
    <link rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.3.1/mapbox-gl-directions.css"
        type="text/css">


    <div id="filters"></div>
    <div id="map"></div>

    <script>
        const filtersDiv = document.getElementById("filters");


        const urlQuery = new URLSearchParams(window.location.search);
        const lat = urlQuery.get('lat') || 40.760631769817024
        const lng = urlQuery.get('lng') || -74.00268401977595
        const theme = urlQuery.get('theme') || 'data.json'

        const appData = {
            filterSelected: null,
            allMarkers: []
        }

        mapboxgl.accessToken =
            "pk.eyJ1IjoiY29zYWx1eCIsImEiOiJja2NraThwczkxdnBuMnhtMnp5Y2x1NjRjIn0.Ri6sI8WAdqNYoKVZOTyhBw";

        console.log('lat,lng', lat, lng);

        const map = new mapboxgl.Map({
            container: "map", // container ID
            style: "mapbox://styles/mapbox/navigation-night-v1", // streetQuest style
            center: [lng, lat],
            zoom: 10, // starting zoom
            pitch: 45,
            bearing: -17.6,
            container: "map",
            antialias: true
        });

        map.addControl(
            new MapboxDirections({
                accessToken: mapboxgl.accessToken,
                profile: 'mapbox/walking'
            }),
            'top-left'
        );

        map.addControl(
            new MapboxGeocoder({
                accessToken: mapboxgl.accessToken,
                mapboxgl: mapboxgl
            }),
            'top-left'
        );

        map.on("style.load", () => {
            // Insert the layer beneath any symbol layer.
            const layers = map.getStyle().layers;
            const labelLayerId = layers.find(
                (layer) => layer.type === "symbol" && layer.layout["text-field"]
            ).id;

            // The 'building' layer in the Mapbox Streets
            // vector tileset contains building height data
            // from OpenStreetMap.
            map.addLayer(
                {
                    id: "add-3d-buildings",
                    source: "composite",
                    "source-layer": "building",
                    filter: ["==", "extrude", "true"],
                    type: "fill-extrusion",
                    minzoom: 15,
                    paint: {
                        "fill-extrusion-color": "#625152",

                        // Use an 'interpolate' expression to
                        // add a smooth transition effect to
                        // the buildings as the user zooms in.
                        "fill-extrusion-height": [
                            "interpolate",
                            ["linear"],
                            ["zoom"],
                            15,
                            0,
                            15.05,
                            ["get", "height"]
                        ],
                        "fill-extrusion-base": [
                            "interpolate",
                            ["linear"],
                            ["zoom"],
                            15,
                            0,
                            15.05,
                            ["get", "min_height"]
                        ],
                        "fill-extrusion-opacity": 0.9
                    }
                },
                labelLayerId
            );

            fetch("data/" + theme)
                .then((response) => response.json())
                .then((data) => {

                    data.logoUrl && createLogo({ logoUrl: data.logoUrl });

                    //map.panTo([lng, lat]);

                    data.geojson.features.forEach((item) => {
                        const popup = new mapboxgl.Popup({ offset: 25 })
                            .setHTML(
                                `<div>
                                    ${item.properties.title}  
                                    <br/>
                                    ${item.properties.message} 
                                    <img class="popup-img" src="${item.properties.iconImage}"/>
                                </div>
                                `
                            )
                            .addTo(map);
                        const markerImg = document.createElement("div");
                        markerImg.id = "marker";
                        markerImg.style.backgroundImage = `url('${item.properties.iconImage}')`;
                        const marker = new mapboxgl.Marker(markerImg)
                            .setLngLat(item.geometry.coordinates)
                            .setPopup(popup)
                            .addTo(map);
                        appData.allMarkers.push({ marker, type: item.properties.type })
                    })
                })
        });


        function createLogo({ logoUrl }) {
            const logo = document.createElement("div");
            logo.className = "logo";

            const img = document.createElement("img");
            img.src = logoUrl
            logo.appendChild(img);

            document.body.appendChild(logo);
        }

        buildFilters({
            filterFunction: (filter) => {
                console.log('filter', filter);
                appData.allMarkers.forEach(({ marker, type }) => {

                    if (type && type.toLowerCase() === filter.toLowerCase()) {
                        marker.addTo(map)
                    } else {
                        marker.remove()
                    }

                })
            }
        })

        function buildFilters({ filterFunction }) {

            const filters = [
                { name: "Eat", color: "#df691a", svgIcon: "/data/icons/food-svgrepo-com.svg" },
                { name: "Do", color: "#5bc0de", svgIcon: "/data/icons/plane-svgrepo-com.svg" },
                { name: "Quick tip", color: "#d9534f", svgIcon: "/data/icons/pin-sharp-circle-624-svgrepo-com.svg" },
                { name: "See", color: "#5cb85c", svgIcon: "/data/icons/photo-svgrepo-com.svg" },
            ]

            const filtersItems = filters.map(item => {

                const filter = document.createElement("div");
                filter.className = "filter-item";
                filter.style.backgroundColor = item.color;

                const text = document.createElement("span");
                text.innerHTML = item.name;
                filter.appendChild(text);

                const img = document.createElement("img");
                img.src = item.svgIcon
                img.style.filter = "invert(100%) sepia(0%) saturate(0%) hue-rotate(93deg) brightness(103%) contrast(103%)";
                img.className = "filter-icon";
                filter.appendChild(img);

                filter.onclick = () => {
                    console.log('filter', item.name);
                    appData.filterSelected = item.name
                    filter.classList.add("selected")
                    if (typeof filterFunction === 'function') {
                        filterFunction(item.name)
                    }

                    //reset border
                    filtersItems.forEach(filterItem => {
                        if (filterItem !== filter) {
                            filterItem.classList.remove("selected")
                        }
                    })
                }

                filtersDiv.appendChild(filter);
                return filter
            })


            return filtersItems
        }
    </script>
</body>

</html>